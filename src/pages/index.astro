---
import BaseLayout from '@/layouts/base-layout.astro'
import Header from '@/components/header.astro'
import { getRecipes, getIngredients } from '@/lib/microcms'
import type { Recipe, Ingredient } from '@/types/microcms'
import Icon from '@/components/icon.astro'
import { faSearch, faCheck } from '@/lib/icons'
import { icon } from '@fortawesome/fontawesome-svg-core'

// Font AwesomeのチェックマークアイコンのSVGを生成
const checkIconData = icon(faCheck)
const checkIconHtml = checkIconData?.html || []
const checkIconSvgContent = Array.isArray(checkIconHtml) ? checkIconHtml.join('') : checkIconHtml
const checkIconViewBox = (checkIconData as { viewBox?: [number, number, number, number] | string })?.viewBox || [0, 0, 512, 512]
const checkIconViewBoxStr = Array.isArray(checkIconViewBox)
  ? `${checkIconViewBox[0]} ${checkIconViewBox[1]} ${checkIconViewBox[2]} ${checkIconViewBox[3]}`
  : checkIconViewBox

// 全レシピ取得
const allRecipes = await getRecipes({ limit: 1000 })
const recipes = allRecipes.contents

// 材料一覧取得（カテゴリ別に分類）
const allIngredients = await getIngredients({ limit: 1000 })
// デバッグ: 材料データの構造を確認
// if (allIngredients.contents.length > 0) {
//   console.log('First ingredient:', JSON.stringify(allIngredients.contents[0], null, 2))
//   console.log('Total ingredients:', allIngredients.contents.length)
// }
const ingredientsByCategory = allIngredients.contents.reduce(
  (acc, ingredient) => {
    const category = ingredient.category || 'その他'
    if (!acc[category]) {
      acc[category] = []
    }
    acc[category].push(ingredient)
    return acc
  },
  {} as Record<string, Ingredient[]>
)
// デバッグ: カテゴリ別の分類結果を確認
// console.log('Ingredients by category:', Object.keys(ingredientsByCategory))

// 調理方法一覧取得
const cookingMethods = Array.from(
  new Set(
    recipes.flatMap((recipe) => recipe.cooking || recipe.cookingMethods || [])
  )
).sort()

// 全レシピデータをクライアントサイドで使用するため、サーバーサイドでのフィルタリングは行わない
// クライアントサイドでURLパラメータに基づいてフィルタリングを行う
---

<BaseLayout title="マイレシピ - トップ">
  <Header />
  <main class="bg-gray-100">
    <div class="container mx-auto px-4 py-16 flex flex-col gap-12">
      <!-- 検索セクション -->
      <section class="bg-white rounded-lg p-8">
        <!-- レシピ名で検索 -->
        <div class="mb-6">
          <h2 class="text-base font-semibold text-gray-800 mb-3">キーワード検索</h2>
          <form method="GET" action="/recipes" class="relative">
            <input
              type="text"
              name="keyword"
              placeholder="キーワード検索"
              class="w-full px-3 py-2 pr-12 border-2 border-gray-300 rounded-md focus:outline-none focus:border-primary"
            />
            <button
              type="submit"
              class="absolute right-2 top-1/2 -translate-y-1/2 text-gray-400 hover:text-primary"
              aria-label="検索"
            >
              <Icon icon={faSearch} size="sm" />
            </button>
          </form>
        </div>
        <!-- 調理方法で検索 -->
        <div class="mb-6">
          <h2 class="text-base font-semibold text-gray-800 mb-3">調理方法で検索</h2>
          <ul class="flex flex-wrap gap-2">
            {cookingMethods.map((method) => (
              <li>
                <a
                  href={`/recipes?cooking=${encodeURIComponent(method)}`}
                  class="inline-flex items-center gap-1 px-3 py-1.5 bg-primary text-white rounded-md hover:bg-green-600 transition-colors text-sm font-medium"
                >
                  <Icon icon={faCheck} size="xs" />
                  {method}
                </a>
              </li>
            ))}
          </ul>
        </div>
        <!-- 材料で検索 -->
        <div class="mb-6">
          <h2 class="text-base font-semibold text-gray-800 mb-3">材料で絞り込み</h2>
          <div class="space-y-4">
            {Object.entries(ingredientsByCategory).map(([category, items]) => (
              <div>
                <h3 class="text-sm font-medium text-gray-700 mb-2">{category}</h3>
                <div class="flex flex-wrap gap-2">
                  {items.map((ingredient) => {
                    const ingredientName = ingredient.title || ingredient.name || '材料名不明'
                    return (
                      <a
                        href={`/recipes?ingredient=${encodeURIComponent(ingredientName)}`}
                        class="px-3 py-1.5 bg-primary text-white rounded-md hover:bg-green-600 transition-colors text-sm"
                      >
                        {ingredientName}
                      </a>
                    )
                  })}
                </div>
              </div>
            ))}
          </div>
        </div>
      </section>
      <!-- レシピ提案エリア -->
      <section>
        <h2 class="text-xl font-semibold text-gray-800 mb-4">ランダムな献立一覧</h2>
        <div id="mood-recipes" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
          <!-- クライアントサイドで動的に生成 -->
        </div>
      </section>
      <!-- タンパク質をとりたい -->
      <!-- <section class="mb-8">
        <h2 class="text-base font-semibold text-gray-800 mb-4">タンパク質をとりたい</h2>
        <div id="protein-recipes" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
        </div>
        <div class="mt-4 text-center">
          <a
            href="/recipes?suggestion=protein"
            class="inline-block px-6 py-2 bg-primary text-white rounded-md hover:bg-green-600 transition-colors text-sm font-medium"
          >
            もっと見る
          </a>
        </div>
      </section> -->
      <!-- 野菜をとりたい -->
      <!-- <section class="mb-8">
        <h2 class="text-base font-semibold text-gray-800 mb-4">野菜をとりたい</h2>
        <div id="vegetable-recipes" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
        </div>
        <div class="mt-4 text-center">
          <a
            href="/recipes?suggestion=vegetable"
            class="inline-block px-6 py-2 bg-primary text-white rounded-md hover:bg-green-600 transition-colors text-sm font-medium"
          >
            もっと見る
          </a>
        </div>
      </section> -->
    </container>
  </main>
</BaseLayout>

<script define:vars={{ recipes, checkIconSvgContent, checkIconViewBoxStr }}>
  // Font AwesomeのfaCheckアイコンのSVG（チェックマーク）
  const checkIconSvg = `<svg class="w-3 h-3 text-primary" fill="currentColor" viewBox="${checkIconViewBoxStr}" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">${checkIconSvgContent}</svg>`

  // URLパラメータを取得
  function getUrlParams() {
    const params = new URLSearchParams(window.location.search)
    return {
      keyword: params.get('keyword') || '',
      cooking: params.get('cooking') || '',
      ingredient: params.get('ingredient') || '',
      suggestion: params.get('suggestion') || '',
      sort: params.get('sort') || 'newest'
    }
  }

  // レシピをフィルタリング
  function filterRecipes(allRecipes, params) {
    let filtered = [...allRecipes]

    // キーワード検索
    if (params.keyword) {
      filtered = filtered.filter((recipe) =>
        recipe.title.toLowerCase().includes(params.keyword.toLowerCase())
      )
    }

    // 調理方法でフィルタリング
    if (params.cooking) {
      filtered = filtered.filter((recipe) => {
        const methods = recipe.cooking || recipe.cookingMethods || []
        return methods.includes(params.cooking)
      })
    }

    // 材料でフィルタリング
    if (params.ingredient) {
      filtered = filtered.filter((recipe) => {
        if (!recipe.ingredients || !Array.isArray(recipe.ingredients)) {
          return false
        }
        return recipe.ingredients.some((item) => {
          const ing = item.ingredients || item.ingredient
          if (!ing || typeof ing !== 'object') return false
          const name = ing.title || ing.name || ''
          return name === params.ingredient
        })
      })
    }

    // 提案でフィルタリング
    if (params.suggestion === 'protein') {
      const proteinCategories = ['肉', '水産物', '卵・チーズ・乳製品', '豆類']
      filtered = filtered.filter((recipe) => {
        if (!recipe.ingredients || !Array.isArray(recipe.ingredients)) {
          return false
        }
        const ingredientCategories = recipe.ingredients
          .map((item) => {
            const ing = item.ingredients || item.ingredient
            return ing && typeof ing === 'object' ? ing.category : null
          })
          .filter((cat) => cat !== null)
        return proteinCategories.some((cat) => ingredientCategories.includes(cat))
      })
    } else if (params.suggestion === 'vegetable') {
      filtered = filtered.filter((recipe) => {
        if (!recipe.ingredients || !Array.isArray(recipe.ingredients)) {
          return false
        }
        const ingredientCategories = recipe.ingredients
          .map((item) => {
            const ing = item.ingredients || item.ingredient
            return ing && typeof ing === 'object' ? ing.category : null
          })
          .filter((cat) => cat !== null)
        return ingredientCategories.includes('野菜')
      })
    }

    // 並び替え
    if (params.sort === 'random') {
      filtered = filtered.sort(() => Math.random() - 0.5)
    } else if (params.sort === 'newest') {
      filtered = filtered.sort((a, b) => {
        const dateA = a.publishedAt ? new Date(a.publishedAt).getTime() : 0
        const dateB = b.publishedAt ? new Date(b.publishedAt).getTime() : 0
        return dateB - dateA
      })
    }

    return filtered
  }

  // ランダムにレシピを選択
  function getRandomRecipes(recipes, count) {
    const shuffled = [...recipes].sort(() => Math.random() - 0.5)
    return shuffled.slice(0, count)
  }

  // レシピカードを生成する関数
  function createRecipeCard(recipe) {
    const cookingMethods = recipe.cooking || recipe.cookingMethods || []
    const methodsHtml = cookingMethods
      .map(
        (method) => `
        <li class="inline-flex items-center gap-1 border border-primary rounded-md px-2 py-1">
          ${checkIconSvg}
          <span class="text-sm text-gray-700">${method}</span>
        </li>
      `
      )
      .join('')

    const descriptionHtml = recipe.description
      ? `<p class="text-sm text-gray-600 leading-relaxed">${recipe.description}</p>`
      : ''

    return `
      <a
        href="/recipes/${recipe.id}"
        class="block p-8 bg-white border border-gray-200 rounded-lg hover:shadow-md transition-shadow"
      >
        <article>
          <h3 class="text-lg font-semibold text-gray-800 mb-3">${recipe.title}</h3>
          <ul class="flex flex-wrap gap-2 mb-3">
            ${methodsHtml}
          </ul>
          ${descriptionHtml}
        </article>
      </a>
    `
  }

  // ページ読み込み時にレシピ一覧を生成
  if (recipes && Array.isArray(recipes)) {
    const params = getUrlParams()

    // ランダムな献立一覧
    const moodRecipesContainer = document.getElementById('mood-recipes')
    if (moodRecipesContainer) {
      const randomRecipes = getRandomRecipes(recipes, 6)
      moodRecipesContainer.innerHTML = randomRecipes.map(createRecipeCard).join('')
    }

    // タンパク質をとりたい
    const proteinCategories = ['肉', '水産物', '卵・チーズ・乳製品', '豆類']
    const proteinRecipes = recipes
      .filter((recipe) => {
        if (!recipe.ingredients || !Array.isArray(recipe.ingredients)) {
          return false
        }
        const ingredientCategories = recipe.ingredients
          .map((item) => {
            const ing = item.ingredients || item.ingredient
            return ing && typeof ing === 'object' ? ing.category : null
          })
          .filter((cat) => cat !== null)
        return proteinCategories.some((cat) => ingredientCategories.includes(cat))
      })
      .sort(() => Math.random() - 0.5)
      .slice(0, 6)

    const proteinRecipesContainer = document.getElementById('protein-recipes')
    if (proteinRecipesContainer) {
      proteinRecipesContainer.innerHTML = proteinRecipes.map(createRecipeCard).join('')
    }

    // 野菜をとりたい
    const vegetableRecipes = recipes
      .filter((recipe) => {
        if (!recipe.ingredients || !Array.isArray(recipe.ingredients)) {
          return false
        }
        const ingredientCategories = recipe.ingredients
          .map((item) => {
            const ing = item.ingredients || item.ingredient
            return ing && typeof ing === 'object' ? ing.category : null
          })
          .filter((cat) => cat !== null)
        return ingredientCategories.includes('野菜')
      })
      .sort(() => Math.random() - 0.5)
      .slice(0, 6)

    const vegetableRecipesContainer = document.getElementById('vegetable-recipes')
    if (vegetableRecipesContainer) {
      vegetableRecipesContainer.innerHTML = vegetableRecipes.map(createRecipeCard).join('')
    }
  }
</script>

